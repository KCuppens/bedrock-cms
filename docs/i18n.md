# Internationalization (i18n) System

Bedrock CMS provides comprehensive internationalization support with translation units, locale fallbacks, and multi-language content management.

## Overview

The i18n system includes:
- **Translation Units**: Atomic translation content with versioning
- **Locale Management**: Language and region configuration
- **Fallback Chain**: Hierarchical locale resolution
- **Content Translation**: Page and block content translation
- **URL Routing**: Locale-aware URL patterns

## Translation Units

Translation units are the core of the i18n system, storing translatable content with metadata.

### TranslationUnit Model

```python
from apps.i18n.models import TranslationUnit

# Create a translation unit
unit = TranslationUnit.objects.create(
    key="homepage.hero.title",
    locale="en-US",
    content="Welcome to Our Website",
    content_type="text",
    namespace="pages"
)
```

### Unit Structure

```python
class TranslationUnit(models.Model):
    key = models.CharField(max_length=255)        # Unique identifier
    locale = models.CharField(max_length=10)      # Language-region code
    content = models.TextField()                   # Translated content
    content_type = models.CharField(max_length=50) # text, html, json
    namespace = models.CharField(max_length=100)   # Grouping identifier
    version = models.IntegerField(default=1)       # Content version
    status = models.CharField(max_length=20)       # draft, published, archived
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = ['key', 'locale', 'version']
```

## Locale System

### Locale Configuration

```python
from apps.i18n.models import Locale

# Create locales
en_us = Locale.objects.create(
    code="en-US",
    name="English (United States)",
    language="en",
    region="US",
    is_default=True,
    is_active=True
)

es_mx = Locale.objects.create(
    code="es-MX",
    name="Spanish (Mexico)",
    language="es",
    region="MX",
    fallback=en_us,  # Falls back to English
    is_active=True
)
```

### Fallback Chain

Locales can have fallback relationships for graceful degradation:

```
es-MX → en-US → (base content)
fr-CA → fr-FR → en-US → (base content)
pt-BR → pt-PT → en-US → (base content)
```

```python
def get_fallback_chain(locale_code):
    """Get the complete fallback chain for a locale."""
    chain = []
    try:
        current = Locale.objects.get(code=locale_code)
        while current:
            chain.append(current.code)
            current = current.fallback
    except Locale.DoesNotExist:
        pass

    # Add default locale if not in chain
    default_locale = Locale.objects.filter(is_default=True).first()
    if default_locale and default_locale.code not in chain:
        chain.append(default_locale.code)

    return chain
```

## Translation Management

### Getting Translations

```python
from apps.i18n.utils import get_translation, get_translations

# Get single translation
title = get_translation("homepage.hero.title", "es-MX", fallback=True)

# Get multiple translations
translations = get_translations([
    "homepage.hero.title",
    "homepage.hero.subtitle",
    "navigation.about"
], "es-MX")
```

### Setting Translations

```python
from apps.i18n.utils import set_translation

# Set translation content
set_translation(
    key="homepage.hero.title",
    locale="es-MX",
    content="Bienvenido a Nuestro Sitio Web",
    content_type="text",
    namespace="pages"
)

# Bulk set translations
translations = {
    "homepage.hero.title": "Bienvenido a Nuestro Sitio Web",
    "homepage.hero.subtitle": "Descubre nuestros servicios",
    "navigation.about": "Acerca de"
}

set_translations(translations, "es-MX", namespace="pages")
```

### Translation Versioning

```python
# Create new version
new_version = set_translation(
    key="homepage.hero.title",
    locale="es-MX",
    content="¡Bienvenido a Nuestro Sitio!",  # Updated content
    create_version=True  # Creates version 2
)

# Get specific version
old_title = get_translation(
    "homepage.hero.title",
    "es-MX",
    version=1
)

# Get version history
versions = TranslationUnit.objects.filter(
    key="homepage.hero.title",
    locale="es-MX"
).order_by('-version')
```

## Content Translation

### Page Translation

```python
from apps.cms.models import Page
from apps.i18n.utils import translate_page

# Create base page
page = Page.objects.create(
    title="About Us",
    slug="about",
    locale="en-US",
    blocks=[
        {
            "type": "hero",
            "props": {
                "title": "About Our Company",
                "subtitle": "Learn about our mission"
            }
        }
    ]
)

# Translate page to Spanish
spanish_page = translate_page(page, "es-MX", {
    "title": "Acerca de Nosotros",
    "blocks": [
        {
            "type": "hero",
            "props": {
                "title": "Acerca de Nuestra Empresa",
                "subtitle": "Conoce nuestra misión"
            }
        }
    ]
})
```

### Block Translation

```python
from apps.i18n.utils import translate_blocks

# Original blocks
blocks = [
    {
        "type": "rich_text",
        "props": {
            "content": "<p>Welcome to our site!</p>"
        }
    },
    {
        "type": "cta_band",
        "props": {
            "title": "Get Started Today",
            "cta_text": "Sign Up"
        }
    }
]

# Translation mappings
translations = {
    "rich_text.content": "<p>¡Bienvenido a nuestro sitio!</p>",
    "cta_band.title": "Comienza Hoy",
    "cta_band.cta_text": "Registrarse"
}

# Translate blocks
translated_blocks = translate_blocks(blocks, "es-MX", translations)
```

## URL Routing

### Locale-aware URLs

```python
# urls.py
from django.urls import path, include
from apps.i18n.urls import i18n_patterns

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('apps.api.urls')),
]

# Add locale-prefixed patterns
urlpatterns += i18n_patterns(
    path('', include('apps.cms.urls')),
    path('blog/', include('apps.blog.urls')),
    prefix_default_language=False,  # Don't prefix default language
)
```

### URL Generation

```python
from django.urls import reverse
from apps.i18n.utils import reverse_locale

# Generate locale-aware URLs
about_url = reverse_locale('page_detail', args=['about'], locale='es-MX')
# Returns: /es-mx/about/

# Current locale URL
current_url = reverse('page_detail', args=['about'])
# Returns: /about/ (if current locale is default)
```

### Middleware

```python
# apps/i18n/middleware.py
class LocaleMiddleware:
    """Middleware to detect and set locale from URL or preferences."""

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # Extract locale from URL
        locale = self.get_locale_from_request(request)

        # Set locale on request
        request.locale = locale
        request.LANGUAGE_CODE = locale.split('-')[0]

        # Activate Django locale
        translation.activate(request.LANGUAGE_CODE)

        response = self.get_response(request)

        # Set locale in response headers
        response['Content-Language'] = locale

        return response
```

## Template Integration

### Template Tags

```python
# apps/i18n/templatetags/i18n_tags.py
from django import template
from apps.i18n.utils import get_translation

register = template.Library()

@register.simple_tag(takes_context=True)
def t(context, key, fallback=""):
    """Get translation for current locale."""
    request = context.get('request')
    locale = getattr(request, 'locale', 'en-US')
    return get_translation(key, locale, fallback=True) or fallback

@register.simple_tag(takes_context=True)
def locale_url(context, locale_code):
    """Generate URL for current page in different locale."""
    request = context.get('request')
    path = request.path

    # Remove current locale prefix
    current_locale = getattr(request, 'locale', 'en-US')
    if path.startswith(f'/{current_locale.lower()}/'):
        path = path[len(current_locale)+2:]

    # Add new locale prefix
    if locale_code != 'en-US':  # Assuming en-US is default
        return f'/{locale_code.lower()}{path}'
    return path
```

### Template Usage

```html
{% load i18n_tags %}

<!DOCTYPE html>
<html lang="{{ request.LANGUAGE_CODE }}">
<head>
    <title>{% t "site.title" "My Website" %}</title>
    <meta name="description" content="{% t "site.description" %}">
</head>
<body>
    <nav>
        <a href="{% locale_url 'en-US' %}">English</a>
        <a href="{% locale_url 'es-MX' %}">Español</a>
        <a href="{% locale_url 'fr-FR' %}">Français</a>
    </nav>

    <h1>{% t "homepage.title" %}</h1>
    <p>{% t "homepage.welcome_message" %}</p>
</body>
</html>
```

## API Integration

### Locale-aware APIs

```python
from rest_framework.response import Response
from apps.i18n.utils import get_translations

class PageViewSet(viewsets.ModelViewSet):
    def retrieve(self, request, *args, **kwargs):
        page = self.get_object()
        locale = request.headers.get('Accept-Language', 'en-US')

        # Get translations for page content
        if hasattr(page, 'translation_keys'):
            translations = get_translations(page.translation_keys, locale)
            page.translations = translations

        serializer = self.get_serializer(page)
        return Response(serializer.data)
```

### Translation API Endpoints

```python
# Translation management API
urlpatterns = [
    path('translations/', TranslationListView.as_view()),
    path('translations/<str:key>/', TranslationDetailView.as_view()),
    path('locales/', LocaleListView.as_view()),
]
```

```http
# Get translations for a key
GET /api/v1/i18n/translations/homepage.title/
{
  "key": "homepage.title",
  "translations": {
    "en-US": "Welcome to Our Website",
    "es-MX": "Bienvenido a Nuestro Sitio Web",
    "fr-FR": "Bienvenue sur Notre Site Web"
  }
}

# Update translation
PUT /api/v1/i18n/translations/homepage.title/
{
  "locale": "es-MX",
  "content": "¡Bienvenido a Nuestro Sitio!"
}
```

## Management Commands

### Import/Export Translations

```bash
# Export translations
python manage.py export_translations --locale=es-MX --format=json --output=translations_es.json

# Import translations
python manage.py import_translations --file=translations_es.json --locale=es-MX

# Sync with translation service
python manage.py sync_translations --service=google --source=en-US --target=es-MX
```

### Translation Statistics

```bash
# Show translation coverage
python manage.py translation_stats

# Find missing translations
python manage.py find_missing_translations --locale=es-MX

# Validate translation keys
python manage.py validate_translations
```

## Locale Seeding

### Seed Common Locales

```python
# management/commands/seed_locales.py
from django.core.management.base import BaseCommand
from apps.i18n.models import Locale

class Command(BaseCommand):
    def handle(self, *args, **options):
        locales = [
            ("en-US", "English (United States)", "en", "US", True, None),
            ("es-MX", "Spanish (Mexico)", "es", "MX", False, "en-US"),
            ("fr-FR", "French (France)", "fr", "FR", False, "en-US"),
            ("pt-BR", "Portuguese (Brazil)", "pt", "BR", False, "en-US"),
            ("de-DE", "German (Germany)", "de", "DE", False, "en-US"),
        ]

        for code, name, lang, region, is_default, fallback_code in locales:
            fallback = None
            if fallback_code:
                fallback = Locale.objects.get(code=fallback_code)

            locale, created = Locale.objects.get_or_create(
                code=code,
                defaults={
                    'name': name,
                    'language': lang,
                    'region': region,
                    'is_default': is_default,
                    'fallback': fallback,
                    'is_active': True,
                }
            )

            if created:
                self.stdout.write(f"Created locale: {code}")
```

## Best Practices

### Key Naming

Use hierarchical, descriptive keys:
```
site.title
site.description
navigation.home
navigation.about
pages.homepage.hero.title
pages.homepage.hero.subtitle
forms.contact.submit_button
errors.validation.required_field
```

### Content Organization

- **Namespace by Feature**: Group related translations
- **Version Control**: Track translation changes
- **Fallback Strategy**: Plan fallback chains carefully
- **Context Information**: Include context for translators

### Performance

- **Caching**: Cache frequently used translations
- **Batch Loading**: Load multiple translations at once
- **Lazy Loading**: Load translations only when needed
- **Database Indexes**: Index commonly queried fields

### Translation Workflow

1. **Extract Strings**: Identify translatable content
2. **Create Keys**: Generate descriptive translation keys
3. **Base Language**: Create content in base language
4. **Professional Translation**: Use professional translators
5. **Review Process**: Review and approve translations
6. **Testing**: Test translated content thoroughly

## Common Patterns

### Site-wide Translations

```python
# Common site elements
SITE_TRANSLATIONS = {
    "en-US": {
        "site.title": "My Website",
        "navigation.home": "Home",
        "navigation.about": "About",
        "navigation.contact": "Contact",
        "footer.copyright": "© 2023 My Company",
    },
    "es-MX": {
        "site.title": "Mi Sitio Web",
        "navigation.home": "Inicio",
        "navigation.about": "Acerca de",
        "navigation.contact": "Contacto",
        "footer.copyright": "© 2023 Mi Empresa",
    }
}
```

### Form Translations

```python
# Form labels and validation messages
FORM_TRANSLATIONS = {
    "en-US": {
        "forms.contact.name": "Name",
        "forms.contact.email": "Email",
        "forms.contact.message": "Message",
        "forms.contact.submit": "Send Message",
        "validation.required": "This field is required",
        "validation.email": "Enter a valid email address",
    },
    "es-MX": {
        "forms.contact.name": "Nombre",
        "forms.contact.email": "Correo electrónico",
        "forms.contact.message": "Mensaje",
        "forms.contact.submit": "Enviar Mensaje",
        "validation.required": "Este campo es obligatorio",
        "validation.email": "Introduce una dirección de correo válida",
    }
}
```

## Integration with External Services

### Google Translate API

```python
from google.cloud import translate_v2 as translate

def auto_translate(text, source_locale, target_locale):
    """Auto-translate text using Google Translate."""
    client = translate.Client()

    source_lang = source_locale.split('-')[0]
    target_lang = target_locale.split('-')[0]

    result = client.translate(
        text,
        source_language=source_lang,
        target_language=target_lang
    )

    return result['translatedText']
```

### Translation Management Platforms

Integration with services like Lokalise, Crowdin, or Phrase:

```python
def sync_with_translation_service():
    """Sync translations with external service."""
    # Export current translations
    translations = export_translations_to_dict()

    # Send to translation service
    service_client.upload_translations(translations)

    # Get updated translations
    updated = service_client.download_translations()

    # Import back to system
    import_translations_from_dict(updated)
```

## Related Documentation

- [Pages System](pages.md)
- [Block System](blocks.md)
- [URL Routing](routing.md)
- [Template System](templates.md)